<template>
  <el-tabs type="card" v-model="activeName" class="demo-tabs">
    <!-- 行为 -->
    <el-tab-pane name="action" class="demo-tab">
      <div style="overflow: hidden; text-align: right; margin-bottom: 20px">
        <el-tooltip content="新增行为" placement="top" effect="light">
          <el-button type="success" @click="addActionDialog">
            <el-icon><Plus /></el-icon>新增
          </el-button>
        </el-tooltip>
        <el-tooltip content="刷新行为列表" placement="top" effect="light">
          <el-button type="primary" @click="getActionList">
            <el-icon><Refresh /></el-icon>刷新
          </el-button>
        </el-tooltip>

        <el-tooltip content="删除行为" placement="top" effect="light">
          <el-button type="danger" @click="deleteAction()">
            <el-icon><Delete /></el-icon>删除
          </el-button>
        </el-tooltip>
        <el-tooltip content="清除当前选择的行为" placement="top" effect="light">
          <el-button type="info" @click="toggleSelection">
            <el-icon><Close /></el-icon>清除
          </el-button>
        </el-tooltip>
      </div>
      <template #label>
        <span class="custom-tabs-label">
          <el-icon><calendar /></el-icon>
          <span>行为</span>
        </span>
      </template>
      <div class="_table">
        <el-table
          border
          ref="multipleAction"
          :data="actionTableData"
          height="67vh"
          style="width: 100%"
          @selection-change="handleSelectionChange"
        >
          <el-table-column type="selection" width="55" />
          <el-table-column label="序号" type="index" width="55"></el-table-column>
          <el-table-column label="行为" prop="actionDescription">
            <!-- <template #default="scope">{{ scope.row.date }}</template> -->
          </el-table-column>
          <el-table-column label="是否需要案例">
            <template #default="scope">
              <span v-if="scope.row.needExample == true" style="color: #f56c6c">是</span>
              <span v-if="scope.row.needExample == false" style="color: #67c23a">否</span>
            </template>
          </el-table-column>
          <el-table-column label="是否使用">
            <template #default="scope">
              <el-col v-if="scope.row.useState == 0" type="info" style="color: #67c23a">未使用</el-col>
              <el-col v-if="scope.row.useState == 1" type="success" style="color: #f56c6c">使用中</el-col>
            </template>
          </el-table-column>
        </el-table>
      </div>
    </el-tab-pane>
    <!-- 价值观 -->

    <el-tab-pane name="value" class="demo-tab">
      <div style="overflow: hidden; text-align: right; margin-bottom: 20px">
        <el-tooltip content="新增价值观" placement="top" effect="light">
          <el-button type="success" @click="isAction = true">
            <el-icon><Plus /></el-icon>新增
          </el-button>
        </el-tooltip>
        <el-tooltip content="刷新价值观列表" placement="top" effect="light">
          <el-button type="primary" @click="getValueList">
            <el-icon><Refresh /></el-icon>刷新
          </el-button>
        </el-tooltip>

        <el-tooltip content="删除价值观" placement="top" effect="light">
          <el-button type="danger" @click="deleteValue()">
            <el-icon><Delete /></el-icon>删除
          </el-button>
        </el-tooltip>
        <el-tooltip content="清除当前选择的价值观" placement="top" effect="light">
          <el-button type="info" @click="toggleSelection">
            <el-icon><Close /></el-icon>清除
          </el-button>
        </el-tooltip>
      </div>
      <template #label>
        <span class="custom-tabs-label">
          <el-icon><calendar /></el-icon>
          <span>价值观</span>
        </span>
      </template>
      <el-table
        border
        class="table-style"
        ref="multipleValue"
        :data="valueTableData"
        @selection-change="handleSelectionChange"
        @expand-change="selectAction"
        height="67vh"
        style="width: 100%"
      >
        <el-table-column type="selection" width="55" />
        <el-table-column label="详情" type="expand" width="55">
          <!-- <el-table :data="selectActionList" height="15rem">
            <el-table-column label="Id" prop="actionId" width="100"></el-table-column>
            <el-table-column label="行为名称" prop="actionDescription"></el-table-column>
          </el-table> -->

          <template #default="scope">
            <div style="padding: 10px 0; margin-left: 110px">
              <el-table
                border
                style="width: 50%"
                v-if="selectActionList[scope.row.valueId]"
                :data="selectActionList[scope.row.valueId].list"
              >
                <!-- <el-table-column prop="actionId" label="ID"></el-table-column> -->
                <el-table-column prop="actionDescription" label="行为描述"></el-table-column>
              </el-table>
            </div>
          </template>
        </el-table-column>
        <!-- <el-table-column label="ID" prop="valueId" width="55"></el-table-column> -->
        <el-table-column label="价值观名称" prop="valueDescription"></el-table-column>
        <el-table-column label="是否使用">
          <template #default="scope">
            <span v-if="scope.row.useState == 0" style="color: #67c23a">未使用</span>
            <span v-if="scope.row.useState == 1" style="color: #f56c6c">使用中</span>
          </template>
        </el-table-column>
        <!-- <el-table-column label="操作">
          <template #default="scope">
            <el-button type="primary" size="small" round plain @click="selectAction(scope.row)">
              {{ scope.row.expanded ? "收起" : "详情" }}
            </el-button>
          </template>
        </el-table-column> -->
      </el-table>
      <!-- <div style="margin-top: 20px">
        <el-button @click="getValueList">刷新</el-button>
        <el-button @click="deleteValue">删除</el-button>
        <el-button @click="toggleSelection">清除选择</el-button>
        <el-button type="success" plain @click="isAction = true">新增价值观</el-button>
      
      </div> -->
    </el-tab-pane>
    <!-- 选择行为创建为价值观的弹窗 -->
    <el-dialog
      v-model="isAction"
      title="请为价值观选择行为"
      width="60%"
      :show-close="false"
      :close-on-click-modal="false"
    >
      <el-table
        border
        stripe
        ref="multipleAction"
        :data="actionTableData"
        style="width: 100%; height: 25rem"
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="55" />
        <el-table-column label="ID" prop="actionId" width="55"></el-table-column>
        <el-table-column label="行为" prop="actionDescription">
          <!-- <template #default="scope">{{ scope.row.date }}</template> -->
        </el-table-column>
        <el-table-column label="是否有案例">
          <template #default="scope">
            <span v-if="scope.row.needExample == true" style="color: #f56c6c">是</span>
            <span v-if="scope.row.needExample == false" style="color: #67c23a">否</span>
          </template>
        </el-table-column>
        <el-table-column label="是否使用">
          <template #default="scope">
            <el-col v-if="scope.row.useState == 0" type="info" style="color: #67c23a">未使用</el-col>
            <el-col v-if="scope.row.useState == 1" type="success" style="color: #f56c6c">使用中</el-col>
          </template>
        </el-table-column>
      </el-table>
      <div style="margin-top: 20px; text-align: right">
        <el-button type="info" plain @click="isAction = false">取消</el-button>
        <el-button type="success" plain @click="sureCreateAction">确定</el-button>
      </div>
    </el-dialog>
    <!-- 模板 -->
    <el-tab-pane name="model" class="demo-tab">
      <div style="overflow: hidden; text-align: right; margin-bottom: 1rem">
        <el-tooltip content="新增模板" placement="top" effect="light">
          <el-button type="success" @click="isValue = true">
            <el-icon><Plus /></el-icon>新增
          </el-button>
        </el-tooltip>
        <el-tooltip content="刷新模板列表" placement="top" effect="light">
          <el-button type="primary" @click="getModelList">
            <el-icon><Refresh /></el-icon>刷新
          </el-button>
        </el-tooltip>

        <el-tooltip content="删除模板" placement="top" effect="light">
          <el-button type="danger" @click="deleteModel()">
            <el-icon><Delete /></el-icon>删除
          </el-button>
        </el-tooltip>
        <el-tooltip content="清除当前选择的模板" placement="top" effect="light">
          <el-button type="info" @click="toggleSelection">
            <el-icon><Close /></el-icon>清除
          </el-button>
        </el-tooltip>
      </div>
      <template #label>
        <span class="custom-tabs-label">
          <el-icon><calendar /></el-icon>
          <span>模板</span>
        </span>
      </template>
      <el-table
        border
        class="table-style"
        ref="multipleModel"
        :data="modelTableData"
        @selection-change="handleSelectionChange"
        @expand-change="selectValue"
        height="67vh"
        style="width: 100%"
      >
        <el-table-column label="选择" type="selection" width="55" />
        <el-table-column label="详情" type="expand" width="55">
          <template #default="scope">
            <div style="padding: 10px 0; margin-left: 110px">
              <el-table
                border
                style="width: 50%"
                v-if="selectValueList[scope.row.templateId]"
                :data="selectValueList[scope.row.templateId].list"
              >
                <el-table-column label="价值观名称" prop="valueDescription"></el-table-column>
              </el-table>
            </div>
          </template>
        </el-table-column>
        <!-- <el-table-column label="ID" prop="templateId" width="55"></el-table-column> -->
        <el-table-column label="模板名称" prop="templateName"></el-table-column>
        <!-- <el-table-column label="描述" prop="description"></el-table-column> -->
        <el-table-column label="是否使用">
          <template #default="scope">
            <span v-if="scope.row.useState == 0" style="color: #67c23a">未使用</span>
            <span v-if="scope.row.useState == 1" style="color: #f56c6c">使用中</span>
          </template>
        </el-table-column>
        <!-- <el-table-column label="操作">
          <template #default="scope">
          <el-button type="primary" size="small" round plain @click="selectValue(scope.row)">
              {{ scope.row.expanded ? "收起" : "详情" }}
            </el-button>
          </template>
        </el-table-column> -->
      </el-table>
      <!-- <div style="margin-top: 20px">
        <el-button @click="getModelList">刷新</el-button>
        <el-button type="danger" @click="deleteModel" plain>删除</el-button>
        <el-button type="success" plain @click="isValue = true">新增模板</el-button>
      </div> -->
    </el-tab-pane>
    <!-- 选择价值观创建为模板的弹窗 -->
    <el-dialog
      v-model="isValue"
      title="请为模板选择价值观"
      width="60%"
      :show-close="false"
      :close-on-click-modal="false"
    >
      <el-table
        border
        stripe
        :data="valueTableData"
        @selection-change="handleSelectionChange"
        @expand-change="selectAction"
        style="height: 25rem"
        ref="multipleValue"
      >
        <el-table-column type="selection" width="55" />
        <el-table-column label="价值观名称" prop="valueDescription"></el-table-column>
        <el-table-column label="是否使用">
          <template #default="scope">
            <span v-if="scope.row.useState == 0" style="color: #67c23a">未使用</span>
            <span v-if="scope.row.useState == 1" style="color: #f56c6c">使用中</span>
          </template>
        </el-table-column>
      </el-table>
      <div style="margin-top: 1rem; text-align: right">
        <el-button type="info" plain @click="isValue = false">取消</el-button>
        <el-button type="success" plain @click="sureCreateAction">确定</el-button>
      </div>
    </el-dialog>
  </el-tabs>
  <Dialog v-if="dialogShow" v-model:dialogShow="dialogShow" :title="title" @addAction="addAction" />
  <!-- 创建价值观、模板的窗口 -->
  <el-dialog v-model="dialogVisible" :title="titleName" :show-close="false" :close-on-click-modal="false">
    <el-input v-model="valueTitle" style="width: 25rem"></el-input>
    <div style="margin-top: 20px; text-align: right">
      <el-button @click="dialogVisible = false">取消</el-button>
      <el-button @click="create">确定</el-button>
    </div>
  </el-dialog>
</template>

<script>
import {
  getAction,
  deleteAction,
  createValue,
  getValue,
  getModel,
  createModel,
  deleteValue,
  deleteModel,
  getValueDetil,
  getModelDetil,
  addAction,
} from "@/api/values/index";
import Dialog from "../userlist/DialogView.vue";
import { ElMessage, ElMessageBox } from "element-plus";
// import store from "@/store";
import { Calendar, Refresh, Delete, Close, Plus } from "@element-plus/icons-vue";
// import axios from "axios";

export default {
  name: "valueManage",
  components: {
    Calendar,
    Dialog,
    Refresh,
    Delete,
    Close,
    Plus,
  },
  data() {
    return {
      multipleAction: "", //绑定每个表格，用来清除多选
      multipleValue: "",
      multipleModel: "",
      multipleSelection: [], //每个页面多选的数据

      title: "",
      dialogShow: false, //控制新建行为
      dialogVisible: false, //控制创建价值观、模板
      isAction: false, //控制选择行为的弹窗
      isValue: false, //控制选择价值观的弹窗

      valueTitle: "", //价值观标题
      activeName: "action",
      titleName: "", //创建时的名称

      actionTableData: [],
      valueTableData: [], //表格展示的内容
      modelTableData: [],

      selectActionList: {}, //展开的详情
      selectValueList: {},
      selectModelList: {},

      valueDetil: {}, //价值观所有详情
      modelDetil: {},
    };
  },
  mounted() {
    // console.log(process.env.NODE_ENV);
    this.getActionList();
    this.getValueList();
    this.getModelList();

    this.getValueDetil();
    this.getModelDetil();
  },
  methods: {
    getActionList() {
      getAction()
        .then((res) => {
          if (res.data.code == 0) {
            this.actionTableData = res.data.data;
            this.actionTableData.sort(function (a, b) {
              return b.actionId - a.actionId;
            });
            console.log(this.actionTableData);
          }
        })
        .catch(() => {
          ElMessage.error("请求失败");
        });
    },
    getValueList() {
      getValue()
        .then((res) => {
          if (res.data.code == 0) {
            this.getValueDetil();
            this.valueTableData = res.data.data.map((val) => {
              const expanded = false;
              val.expanded = expanded;
              return val;
              // const newObj = { ...val, expanded: true };
              // this.$set(this.valueTableData, this.valueTableData.indexOf(val), newObj);
              // this.$set(val, "expanded", false);
            });
            this.valueTableData.sort(function (a, b) {
              return b.valueId - a.valueId;
            });
          }
          // console.log(this.valueTableData);
        })
        .catch(() => {
          ElMessage.error("请求失败");
        });
    },
    getModelList() {
      getModel()
        .then((res) => {
          if (res.data && res.data.code == 0) {
            // console.log(res, 11111111);
            this.getModelDetil();
            this.modelTableData = res.data.data;
            // console.log(res.data.data);
            this.modelTableData.sort(function (a, b) {
              return b.templateId - a.templateId;
            });
          }
        })
        .catch((err) => {
          console.log(err, 22222);
        });
    },

    getValueDetil() {
      getValueDetil()
        .then((res) => {
          if (res.data.code == 0) {
            this.valueDetil = [];
            this.valueDetil = res.data.data;
            // console.log("价值观详情", this.valueDetil);
          }
        })
        .catch(() => {
          ElMessage.error("请求失败");
        });
    },
    getModelDetil() {
      getModelDetil()
        .then((res) => {
          if (res.data.code == 0) {
            this.modelDetil = res.data.data;
          }
        })
        .catch(() => {
          ElMessage.error("请求失败");
        });
    },

    toggleSelection() {
      this.$refs.multipleAction.clearSelection();
      console.log("已清除多选");
      this.$refs.multipleValue.clearSelection();
      this.$refs.multipleModel.clearSelection();
    },
    //多选的结果
    handleSelectionChange(val) {
      this.multipleSelection = val;
    },
    //弹窗选择
    sureCreateAction() {
      if (this.multipleSelection.length > 0) {
        if (this.activeName == "value") {
          this.titleName = "价值观名称";
        } else if (this.activeName == "model") {
          this.titleName = "模板名称";
        }
        this.dialogVisible = true;
      } else {
        if (this.activeName == "value") {
          ElMessage.error("请选择行为");
        } else if (this.activeName == "model") {
          ElMessage.error("请选择价值观");
        }
      }
    },

    async create() {
      //   this.dialogVisible = true;

      //选中行为创建价值观
      if (this.activeName == "value") {
        if (this.valueTitle !== null && this.valueTitle.split(" ").join("").length !== 0) {
          const actionId = this.multipleSelection.map((item) => {
            return item.actionId;
          });
          // this.valueTitle = this.valueTitle.replace(/[*]/g, "");
          console.log(this.valueTitle);
          const actionList = { actionIdList: actionId, valueDescription: this.valueTitle };
          await createValue(actionList);
          this.toggleSelection();
          this.valueTitle = "";
          this.dialogVisible = false;
          this.isAction = false;
          // this.activeName = "value";
          this.getValueList();
          this.getActionList();
        } else {
          ElMessage.error("请输入价值观标题");
        }

        //选中价值观创建模板
      } else if (this.activeName == "model") {
        if (this.valueTitle !== null && this.valueTitle.split(" ").join("").length !== 0) {
          const valueId = this.multipleSelection.map((item) => {
            return item.valueId;
          });
          const valueList = { valueIdList: valueId, templateName: this.valueTitle };
          await createModel(valueList);
          this.toggleSelection();
          this.valueTitle = "";
          this.dialogVisible = false;
          this.isValue = false;
          // this.activeName = "model";
          this.getModelList();
          this.getValueList();
          // this.getValueDetil();
        } else {
          ElMessage.error("请输入模板标题");
        }
      }
    },
    async addAction(val) {
      await addAction(val);
      this.getActionList();
    },
    addActionDialog() {
      (this.title = "新增行为"), (this.dialogShow = true);
    },
    deleteAction() {
      if (this.multipleSelection.length > 0) {
        ElMessageBox.confirm("确定删除此行为吗?", "提示", {
          confirmButtonText: "确认",
          cancelButtonText: "取消",
          type: "warning",
        })
          .then(() => {
            const actionId = this.multipleSelection.map((item) => {
              return item.actionId;
            });
            const actionIds = { actionIds: actionId };
            console.log(actionIds);
            deleteAction(actionIds).then(() => {
              this.getActionList();
            });
          })
          .catch(() => {
            ElMessage.info("取消删除");
          });
      } else {
        ElMessage.error("请选择需要删除的行为");
      }
    },
    async deleteValue() {
      try {
        if (this.multipleSelection.length > 0) {
          const result = await ElMessageBox.confirm("确定删除此价值观吗?", "提示", {
            confirmButtonText: "确认",
            cancelButtonText: "取消",
            type: "warning",
          });

          if (result) {
            const valueId = this.multipleSelection.map((item) => {
              return item.valueId;
            });
            const valueIds = { valueIds: valueId };
            await deleteValue(valueIds);
            this.getValueList();
          }
        } else {
          ElMessage.error("请选择需要删除的价值观");
        }
      } catch (error) {
        console.error(error);
      }
    },

    deleteModel() {
      if (this.multipleSelection.length > 0) {
        ElMessageBox.confirm("确定删除此模板吗?", "提示", {
          confirmButtonText: "确认",
          cancelButtonText: "取消",
          type: "warning",
        })
          .then(() => {
            const templateId = this.multipleSelection.map((item) => {
              return item.templateId;
            });
            const templateIds = { tempIdList: templateId };
            deleteModel(templateIds).then(() => {
              this.getModelList();
            });
          })
          .catch(() => {
            ElMessage.info("取消删除");
          });
      } else {
        ElMessage.error("请选择需要删除的模板");
      }
    },
    //查询单个价值观里的详情
    selectAction(row) {
      console.log(row.valueId);
      if (row.valueId) {
        const tableData = this.valueDetil.filter((item) => item.valueId == row.valueId);
        console.log("单个价值观详情", tableData);
        if (tableData != []) {
          let result = tableData.reduce((acc, curr) => {
            if (!acc[curr.valueId]) {
              acc[curr.valueId] = {
                list: [],
              };
            }
            acc[curr.valueId].list.push({ actionId: curr.actionId, actionDescription: curr.actionDescription });
            return acc;
          }, {});
          //每点击一次将新的数据存入对象中，确保每一次的数据不会替换
          for (let key in result) {
            this.selectActionList[key] = result[key];
          }
        } else {
          this.getValueDetil();
        }
      } else {
        ElMessage.error("暂无数据");
      }

      // console.log(result);
      // console.log(this.selectActionList);
    },
    //查询模板里的价值观详情
    selectValue(row) {
      // console.log(this.modelDetil, row);
      if (this.modelDetil) {
        const tableData = this.modelDetil.filter((item) => item.templateid == row.templateId);
        // console.log(tableData);
        let result = tableData.reduce((acc, curr) => {
          if (!acc[curr.templateid]) {
            acc[curr.templateid] = {
              list: [],
            };
          }
          acc[curr.templateid].list.push({ valueId: curr.valueId, valueDescription: curr.valueDescription });
          return acc;
        }, {});
        //每点击一次将新的数据存入对象中，确保每一次的数据不会替换
        for (let key in result) {
          this.selectValueList[key] = result[key];
        }
      }

      // console.log(this.selectValueList);
      // console.log(result);
    },
  },
};
</script>

<style lang="scss" scoped>
.demo-tabs {
  background-color: #fff;
  height: 96%;
  border-radius: 10px;
  padding: 0;
}
.demo-tab {
  padding: 0 15px 0 15px;
}
.el-tabs--card > .el-tabs__header .el-tabs__item {
  font-size: 14px;
}
// .demo-tabs .custom-tabs-label .el-icon {
//   vertical-align: middle;
// }
// .demo-tabs .custom-tabs-label span {
//   vertical-align: middle;
//   margin-left: 4px;
// }
.demo-tabs > .el-tabs__content {
  padding: 0;
  color: #6b778c;
  font-size: 32px;
  font-weight: 600;
}
.el-tabs__content {
  overflow: hidden;
  position: relative;
}
.el-tabs {
  height: 100%;
  --el-tabs-header-height: 55px;
  .el-tabs__item {
    font-size: 1rem;
  }
}
// .titleForm {
//   display: flex;
//   justify-content: space-around;
// }
.el-table--border th.el-table__cell {
  font-size: 14px;
}

.el-table .el-table__cell {
  font-size: 12px;
  font-weight: normal;
  color: #606260;
}
/* 表格宽度自适应 */
.el-table {
  width: 100%;
  .el-table__header-wrapper table,
  .el-table__body-wrapper table {
    width: 100% !important;
  }
  .el-table__body,
  .el-table__footer,
  .el-table__header {
    table-layout: auto;
  }
}

.table-style {
  .el-table-column--selection.is-leaf .el-checkbox {
    display: none;
  }
}
/* ---el-table滚动条公共样式--- */
// .el-scrollbar .el-scrollbar__bar.is-vertical .el-scrollbar__thumb {
//   height: 45px !important;
// }
.el-icon {
  margin-right: 5px;
}
</style>
